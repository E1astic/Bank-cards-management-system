# Система управления банковскими картами

---

**Приложение для создания и управления банковскими картами, денежными переводами и пользователями. 
Используется аутентификация/авторизация и разделение ролей на ADMIN и USER.**

---

## В проекте используются:
- Java 21
- Spring Boot 3.5.3
- Spring Web
- Spring Data JPA
- Spring Security + JWT
- PostgreSQL
- Liquibase
- Docker
- OpenAPI (Swagger)

---

## Инструкция по запуску приложения:
1. Запустить файл `docker-compose.yaml` в корне проекта. Запустится база данных
   на порту **5443**.
2. Запустить класс `BankCardsApplication`. Приложение запустится на порту **8075**. 
   Миграции Liquibase будут накатываться автоматически.

* Документация Swagger будет доступна после запуска приложения  по адресу: http://localhost:8075/bank-cards/swagger-ui/index.html


* Liquibase-миграции создают 1 администратора и 1 пользователя. Логины и пароли для входа:
  * **admin@mail.ru, adminadmin**
  * **user@mail.ru, useruser**

   Функционал, который можно выполнять от лица разных ролей, описан в разделе ниже.

---

## Основной функционал приложения:

### Администраторы:

1. Регистрируют новые банковские карты пользователям.
2. Имеют доступ ко всем картам (с возможностью постраничной выдачи данных).
3. Могут менять статус карты - `ACTIVE`, `BLOCKED`, `EXPIRED`. При блокировки карты статус всех 
   заявок на блокировку этой карты меняется на `COMPLETED`.
4. Могут блокировать карту в связи с истечением срока действия. 
    * с помощью вызова одного API выполняется поиск всех карт, у которых истекает срок действия. 
      Статус таких карт автоматичечки устанавливается в `EXPIRED`).
    * есть API для проверки карт на истечение срока в текущую дату, а также в любую прошедшую дату, если
      администратор забыл или не успел выполнить проверку днями ранее).
5. Могут удалять карты. Эта карта удаляется из всех заявок на блокировку (без проблемы N + 1).
6. Видят все заявки пользователей на блокировку карт.
7. Меняют данные пользователя (все данные кроме ID и email).
8. Могут удалять пользователя. Тогда у всех его карт удаляется владелец (без проблемы N + 1).

### Пользователи:

1. Регистрируются и логинятся в приложении.
2. Имеют доступ ко всем своим картам (с возможностью постраничной выдачи данных).
3. Получают свои карты по ID.
4. Могут увидеть суммарный баланс всех своих активированных карт.
5. Могут увидеть баланс своей конкретной карты.
6. Могут отправить заявку на блокировку своей карты.
7. Совершают денежные переводы между своими картами.

---

## Безопасность в приложении

1. Доступ к приложению осуществляется с помощью аутентификации и авторизации. 
   Все API требуют аутентификации за исключением регистрации и входа в аккаунт.
2. Существуют 2 роли: ADMIN и USER. У каждой роли свои привилегии.
3. Пароли пользователей хэшируются в БД.
4. Номера банковских карт шифруются в БД.
5. При получении информации о картах, по стандарту их номер маскируется в формате:
   `**** **** **** 1234`. Для управления отображением номера в API существует параметр `fullNumber`.
   Если он принимает значения `null` или `false`, то номер маскируется, если `true` - отображается полный номер.



### Везде, где происходит ввод информации, детально настроена валидация ошибок. 
**Пользователь информируется обо всех ошибках.**

**Примеры:**

1. Для совершения денежного перевода между картами необходимо, чтобы:
   * обе карты существовали
   * обе карты принадлежали текущему пользователю
   * обе карты были активированы (без блокировки и без истечения срока действия)
   * на карте списания должно быть достаточно средств для перевода
2. Для регистрации пользователя необходимо, чтобы:
   * email был корректным и уникальным
   * номер телефона в корректном формате и уникальным
   * пароль был не менее 8 символов
   * фамилия, имя и отчество должны быть от 2 до 60 символов
3. Для отправки заявки на блокировку карты необходимо, чтобы:
   * карта существовала
   * карта принадлежала текущему пользователю
   * карта не была уже заблокированной

* Валидация установлена не только на объекты (`@RequestBody`, то есть сущности регистрации карт, пользователей, совершения денежного перевода и др.), 
   но и на составляющие запросов (`@RequestParam` и `@PathVariable`). Например, в запросе нельзя: 
  * передать неположительный ID (`/bank-cards/card/my/-2`)
  * передать некорректный статус карты (`block` вместо `blocked`, `expire` вместо `expired` или любое другое неподходящее значение)
  * в пагинации (постраничной выдачи) нельзя передать пераметр `size <= 0` или `page < 0`

**Обо всех возникающих ошибках пользователь уведомляется сообщениями.**

---

